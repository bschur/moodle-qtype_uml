{"version":3,"file":"uml-editor.min.js","sources":["../src/uml-editor.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\nimport {decodeDiagram, encodeDiagram} from \"./uml-editor-compression.js\";\n\nconst templateHTML = `\n<style>\n    :host {\n        display: flex;\n        flex-direction: row;\n        height: 100%;\n        width: 100%;\n        gap: 2px;\n        padding: 4px;\n    }\n    \n    .left {\n        width: 30%;\n        background-color: grey;\n    }\n    \n    .right {\n        width: 100%;\n        background-color: grey;\n    }\n</style>\n    \n<div class=\"left\">\n    <canvas id=\"canvasTool\"></canvas>\n</div>\n<div class=\"right\">\n    <canvas id=\"canvasEditor\"></canvas>\n</div>\n`;\n\nexport class UmlEditor extends HTMLElement {\n    canvasEditor = null;\n    ctxEditor = null;\n\n    canvasTool = null;\n    ctxTool = null;\n\n    offsetX = 0;\n    offsetY = 0;\n    draggedObject = null;\n\n    objects = [];\n\n    eventBuffer = [];\n    bufferTimeout = null;\n\n    get attributeInputId() {\n        return this.getAttribute('inputId');\n    }\n\n    get attributeDiagram() {\n        const diagram = this.getAttribute('diagram');\n        return decodeDiagram(diagram);\n    }\n\n    get attributeAllowEdit() {\n        return this.getAttribute('allowEdit') === '1';\n    }\n\n    constructor() {\n        super();\n        this.attachShadow({mode: 'open'});\n\n        // Create the template for the shadow DOM\n        this.shadowRoot.innerHTML = templateHTML;\n    }\n\n    connectedCallback() {\n        // Initialize canvas elements and contexts\n        this.initCanvas('canvasEditor', 'ctxEditor');\n        this.initCanvas('canvasTool', 'ctxTool');\n\n        if (this.attributeAllowEdit) {\n            // Initial rendering\n            this.drawObjectTool();\n\n            // Setup event listeners\n            this.setupListeners();\n        } else {\n            // Hide toolbox (left part)\n            this.shadowRoot.querySelector('.left').style.display = 'none';\n        }\n\n        this.displayDiagramSchema(this.attributeDiagram);\n    }\n\n    detachedCallback() {\n        this.emitDiagramChanged();\n    }\n\n    initCanvas(canvasId, contextId) {\n        const canvas = this.shadowRoot.getElementById(canvasId);\n        const context = canvas.getContext('2d');\n\n        canvas.width = canvas.parentElement.clientWidth;\n        canvas.height = canvas.parentElement.clientHeight;\n\n        this[canvasId] = canvas;\n        this[contextId] = context;\n    }\n\n    displayDiagramSchema(diagramObjects) {\n        if (diagramObjects) {\n            this.objects = diagramObjects;\n            this.drawObjectEditor();\n        }\n    }\n\n    emitDiagramChanged() {\n        const diagram = encodeDiagram(this.objects);\n\n        const event = new CustomEvent('diagramChanged', {\n            bubbles: true,\n            detail: {\n                inputId: this.attributeInputId,\n                diagram,\n            }\n        });\n\n        // Add the event to the buffer\n        this.eventBuffer.push(event);\n\n        // If there's a buffer timeout already set, clear it\n        if (this.bufferTimeout) {\n            clearTimeout(this.bufferTimeout);\n        }\n\n        // Set a new buffer timeout to emit the events after 500ms\n        this.bufferTimeout = setTimeout(() => {\n            this.dispatchEvent(this.eventBuffer[this.eventBuffer.length - 1]);\n\n            // Clear the buffer and the buffer timeout\n            this.eventBuffer.splice(0, this.eventBuffer.length);\n            this.bufferTimeout = null;\n        }, 100);\n    }\n\n    drawObjectEditor() {\n        // Clear the editor canvas and draw objects\n        this.ctxEditor.clearRect(0, 0, this.canvasEditor.width, this.canvasEditor.height);\n        for (const obj of this.objects) {\n            this.ctxEditor.fillStyle = obj.color;\n            this.ctxEditor.fillRect(obj.x, obj.y, obj.width, obj.height);\n        }\n    }\n\n    drawObjectTool() {\n        // Clear the tool canvas and draw a sample object\n        this.ctxTool.clearRect(0, 0, this.canvasTool.width, this.canvasTool.height);\n        this.ctxTool.fillStyle = 'blue';\n        this.ctxTool.fillRect(100, 100, 50, 50);\n    }\n\n    findTopObject(x, y) {\n        // Find the top object at the given coordinates\n        for (let i = this.objects.length - 1; i >= 0; i--) {\n            const obj = this.objects[i];\n            if (x >= obj.x && x <= obj.x + obj.width && y >= obj.y && y <= obj.y + obj.height) {\n                return obj;\n            }\n        }\n        return null; // No object found\n    }\n\n    setupListeners() {\n        // Save dragged object\n        this.canvasEditor.addEventListener('mousedown', (event) => {\n            const x = event.clientX - this.canvasEditor.getBoundingClientRect().left;\n            const y = event.clientY - this.canvasEditor.getBoundingClientRect().top;\n\n            this.draggedObject = this.findTopObject(x, y);\n\n            if (this.draggedObject) {\n                this.offsetX = x - this.draggedObject.x;\n                this.offsetY = y - this.draggedObject.y;\n            }\n        });\n\n        // Refresh Editor for every mousemove\n        this.canvasEditor.addEventListener('mousemove', (event) => {\n            if (this.draggedObject) {\n                const x = event.clientX - this.canvasEditor.getBoundingClientRect().left;\n                const y = event.clientY - this.canvasEditor.getBoundingClientRect().top;\n                this.draggedObject.x = x - this.offsetX;\n                this.draggedObject.y = y - this.offsetY;\n                this.objects[this.draggedObject.id - 1] = this.draggedObject;\n\n                this.emitDiagramChanged();\n                this.drawObjectEditor();\n            }\n        });\n\n        // Save location of dragged object\n        this.canvasEditor.addEventListener('mouseup', () => {\n            if (this.draggedObject) {\n                this.objects[this.draggedObject.id - 1] = this.draggedObject;\n                this.draggedObject = null;\n            }\n        });\n\n        // Draw an instance of a click object (in Toolbox) on the editor\n        this.canvasTool.addEventListener('click', (event) => {\n            event.preventDefault();\n            const obj = {\n                id: this.objects.length + 1,\n                x: 100,\n                y: 100,\n                width: 50,\n                height: 50,\n                color: 'blue',\n            };\n            this.objects.push(obj);\n\n            this.emitDiagramChanged();\n            this.drawObjectEditor();\n        });\n    }\n}"],"names":["UmlEditor","HTMLElement","attributeInputId","this","getAttribute","attributeDiagram","diagram","attributeAllowEdit","constructor","attachShadow","mode","shadowRoot","innerHTML","connectedCallback","initCanvas","drawObjectTool","setupListeners","querySelector","style","display","displayDiagramSchema","detachedCallback","emitDiagramChanged","canvasId","contextId","canvas","getElementById","context","getContext","width","parentElement","clientWidth","height","clientHeight","diagramObjects","objects","drawObjectEditor","event","CustomEvent","bubbles","detail","inputId","eventBuffer","push","bufferTimeout","clearTimeout","setTimeout","dispatchEvent","length","splice","ctxEditor","clearRect","canvasEditor","obj","fillStyle","color","fillRect","x","y","ctxTool","canvasTool","findTopObject","i","addEventListener","clientX","getBoundingClientRect","left","clientY","top","draggedObject","offsetX","offsetY","id","preventDefault"],"mappings":"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"}