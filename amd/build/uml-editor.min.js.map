{"version":3,"file":"uml-editor.min.js","sources":["../src/uml-editor.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\nimport { decodeDiagram, encodeDiagram } from './uml-editor-compression.js';\nimport { emitDiagramDataChangedEvent } from './uml-editor-change-handler.js';\nconst templateHTML = `\n<style>\n    :host {\n        display: flex;\n        flex-direction: row;\n        height: 100%;\n        width: 100%;\n        gap: 2px;\n        padding: 4px;\n    }\n    \n    .left {\n        width: 30%;\n        background-color: grey;\n    }\n    \n    .right {\n        width: 100%;\n        background-color: grey;\n    }\n</style>\n    \n<div class=\"left\">\n    <canvas id=\"canvasTool\"></canvas>\n</div>\n<div class=\"right\">\n    <canvas id=\"canvasEditor\"></canvas>\n</div>\n`;\nexport class UmlEditor extends HTMLElement {\n  canvasEditor = null;\n  ctxEditor = null;\n  canvasTool = null;\n  ctxTool = null;\n  offsetX = 0;\n  offsetY = 0;\n  draggedObject = null;\n  objects = [];\n  get attributeInputId() {\n    return this.getAttribute('inputId');\n  }\n  get attributeDiagram() {\n    const diagram = this.getAttribute('diagram');\n    return decodeDiagram(diagram);\n  }\n  get attributeAllowEdit() {\n    return this.getAttribute('allowEdit') === '1';\n  }\n  constructor() {\n    super();\n    this.attachShadow({\n      mode: 'open'\n    });\n\n    // Create the template for the shadow DOM\n    this.shadowRoot.innerHTML = templateHTML;\n  }\n  connectedCallback() {\n    // Initialize canvas elements and contexts\n    this.initCanvas('canvasEditor', 'ctxEditor');\n    this.initCanvas('canvasTool', 'ctxTool');\n    if (this.attributeAllowEdit) {\n      // Initial rendering\n      this.drawObjectTool();\n\n      // Setup event listeners\n      this.setupListeners();\n    } else {\n      // Hide toolbox (left part)\n      this.shadowRoot.querySelector('.left').style.display = 'none';\n    }\n    this.displayDiagramSchema(this.attributeDiagram);\n  }\n  detachedCallback() {\n    this.emitDiagramChanged();\n  }\n  initCanvas(canvasId, contextId) {\n    const canvas = this.shadowRoot.getElementById(canvasId);\n    const context = canvas.getContext('2d');\n    canvas.width = canvas.parentElement.clientWidth;\n    canvas.height = canvas.parentElement.clientHeight;\n    this[canvasId] = canvas;\n    this[contextId] = context;\n  }\n  displayDiagramSchema(diagramObjects) {\n    if (diagramObjects) {\n      this.objects = diagramObjects;\n      this.drawObjectEditor();\n    }\n  }\n  drawObjectEditor() {\n    // Clear the editor canvas and draw objects\n    this.ctxEditor.clearRect(0, 0, this.canvasEditor.width, this.canvasEditor.height);\n    for (const obj of this.objects) {\n      this.ctxEditor.fillStyle = obj.color;\n      this.ctxEditor.fillRect(obj.x, obj.y, obj.width, obj.height);\n    }\n  }\n  drawObjectTool() {\n    // Clear the tool canvas and draw a sample object\n    this.ctxTool.clearRect(0, 0, this.canvasTool.width, this.canvasTool.height);\n    this.ctxTool.fillStyle = 'blue';\n    this.ctxTool.fillRect(100, 100, 50, 50);\n  }\n  findTopObject(x, y) {\n    // Find the top object at the given coordinates\n    for (let i = this.objects.length - 1; i >= 0; i--) {\n      const obj = this.objects[i];\n      if (x >= obj.x && x <= obj.x + obj.width && y >= obj.y && y <= obj.y + obj.height) {\n        return obj;\n      }\n    }\n    return null; // No object found\n  }\n  setupListeners() {\n    // Save dragged object\n    this.canvasEditor.addEventListener('mousedown', event => {\n      const x = event.clientX - this.canvasEditor.getBoundingClientRect().left;\n      const y = event.clientY - this.canvasEditor.getBoundingClientRect().top;\n      this.draggedObject = this.findTopObject(x, y);\n      if (this.draggedObject) {\n        this.offsetX = x - this.draggedObject.x;\n        this.offsetY = y - this.draggedObject.y;\n      }\n    });\n\n    // Refresh Editor for every mousemove\n    this.canvasEditor.addEventListener('mousemove', event => {\n      if (this.draggedObject) {\n        const x = event.clientX - this.canvasEditor.getBoundingClientRect().left;\n        const y = event.clientY - this.canvasEditor.getBoundingClientRect().top;\n        this.draggedObject.x = x - this.offsetX;\n        this.draggedObject.y = y - this.offsetY;\n        this.objects[this.draggedObject.id - 1] = this.draggedObject;\n        this.emitDiagramChanged();\n        this.drawObjectEditor();\n      }\n    });\n\n    // Save location of dragged object\n    this.canvasEditor.addEventListener('mouseup', () => {\n      if (this.draggedObject) {\n        this.objects[this.draggedObject.id - 1] = this.draggedObject;\n        this.draggedObject = null;\n      }\n    });\n\n    // Draw an instance of a click object (in Toolbox) on the editor\n    this.canvasTool.addEventListener('click', event => {\n      event.preventDefault();\n      const obj = {\n        id: this.objects.length + 1,\n        x: 100,\n        y: 100,\n        width: 50,\n        height: 50,\n        color: 'blue'\n      };\n      this.objects.push(obj);\n      this.emitDiagramChanged();\n      this.drawObjectEditor();\n    });\n  }\n  emitDiagramChanged() {\n    const diagram = encodeDiagram(this.objects);\n    emitDiagramDataChangedEvent(this.attributeInputId, diagram);\n  }\n}"],"names":["UmlEditor","HTMLElement","attributeInputId","this","getAttribute","attributeDiagram","diagram","attributeAllowEdit","constructor","attachShadow","mode","shadowRoot","innerHTML","connectedCallback","initCanvas","drawObjectTool","setupListeners","querySelector","style","display","displayDiagramSchema","detachedCallback","emitDiagramChanged","canvasId","contextId","canvas","getElementById","context","getContext","width","parentElement","clientWidth","height","clientHeight","diagramObjects","objects","drawObjectEditor","ctxEditor","clearRect","canvasEditor","obj","fillStyle","color","fillRect","x","y","ctxTool","canvasTool","findTopObject","i","length","addEventListener","event","clientX","getBoundingClientRect","left","clientY","top","draggedObject","offsetX","offsetY","id","preventDefault","push"],"mappings":"uaA8CaA,kBAAkBC,YASzBC,8BACKC,KAAKC,aAAa,WAEvBC,6BACIC,QAAUH,KAAKC,aAAa,kBAC3B,uCAAcE,SAEnBC,+BACwC,MAAnCJ,KAAKC,aAAa,aAE3BI,0DAlBe,uCACH,wCACC,qCACH,qCACA,kCACA,wCACM,qCACN,SAaHC,aAAa,CAChBC,KAAM,cAIHC,WAAWC,ofAElBC,yBAEOC,WAAW,eAAgB,kBAC3BA,WAAW,aAAc,WAC1BX,KAAKI,yBAEFQ,sBAGAC,uBAGAL,WAAWM,cAAc,SAASC,MAAMC,QAAU,YAEpDC,qBAAqBjB,KAAKE,kBAEjCgB,wBACOC,qBAEPR,WAAWS,SAAUC,iBACbC,OAAStB,KAAKQ,WAAWe,eAAeH,UACxCI,QAAUF,OAAOG,WAAW,MAClCH,OAAOI,MAAQJ,OAAOK,cAAcC,YACpCN,OAAOO,OAASP,OAAOK,cAAcG,kBAChCV,UAAYE,YACZD,WAAaG,QAEpBP,qBAAqBc,gBACfA,sBACGC,QAAUD,oBACVE,oBAGTA,wBAEOC,UAAUC,UAAU,EAAG,EAAGnC,KAAKoC,aAAaV,MAAO1B,KAAKoC,aAAaP,YACrE,MAAMQ,OAAOrC,KAAKgC,aAChBE,UAAUI,UAAYD,IAAIE,WAC1BL,UAAUM,SAASH,IAAII,EAAGJ,IAAIK,EAAGL,IAAIX,MAAOW,IAAIR,QAGzDjB,sBAEO+B,QAAQR,UAAU,EAAG,EAAGnC,KAAK4C,WAAWlB,MAAO1B,KAAK4C,WAAWf,aAC/Dc,QAAQL,UAAY,YACpBK,QAAQH,SAAS,IAAK,IAAK,GAAI,IAEtCK,cAAcJ,EAAGC,OAEV,IAAII,EAAI9C,KAAKgC,QAAQe,OAAS,EAAGD,GAAK,EAAGA,IAAK,OAC3CT,IAAMrC,KAAKgC,QAAQc,MACrBL,GAAKJ,IAAII,GAAKA,GAAKJ,IAAII,EAAIJ,IAAIX,OAASgB,GAAKL,IAAIK,GAAKA,GAAKL,IAAIK,EAAIL,IAAIR,cAClEQ,WAGJ,KAETxB,sBAEOuB,aAAaY,iBAAiB,aAAaC,cACxCR,EAAIQ,MAAMC,QAAUlD,KAAKoC,aAAae,wBAAwBC,KAC9DV,EAAIO,MAAMI,QAAUrD,KAAKoC,aAAae,wBAAwBG,SAC/DC,cAAgBvD,KAAK6C,cAAcJ,EAAGC,GACvC1C,KAAKuD,qBACFC,QAAUf,EAAIzC,KAAKuD,cAAcd,OACjCgB,QAAUf,EAAI1C,KAAKuD,cAAcb,WAKrCN,aAAaY,iBAAiB,aAAaC,WAC1CjD,KAAKuD,cAAe,OAChBd,EAAIQ,MAAMC,QAAUlD,KAAKoC,aAAae,wBAAwBC,KAC9DV,EAAIO,MAAMI,QAAUrD,KAAKoC,aAAae,wBAAwBG,SAC/DC,cAAcd,EAAIA,EAAIzC,KAAKwD,aAC3BD,cAAcb,EAAIA,EAAI1C,KAAKyD,aAC3BzB,QAAQhC,KAAKuD,cAAcG,GAAK,GAAK1D,KAAKuD,mBAC1CpC,0BACAc,4BAKJG,aAAaY,iBAAiB,WAAW,KACxChD,KAAKuD,qBACFvB,QAAQhC,KAAKuD,cAAcG,GAAK,GAAK1D,KAAKuD,mBAC1CA,cAAgB,cAKpBX,WAAWI,iBAAiB,SAASC,QACxCA,MAAMU,uBACAtB,IAAM,CACVqB,GAAI1D,KAAKgC,QAAQe,OAAS,EAC1BN,EAAG,IACHC,EAAG,IACHhB,MAAO,GACPG,OAAQ,GACRU,MAAO,aAEJP,QAAQ4B,KAAKvB,UACblB,0BACAc,sBAGTd,2BACQhB,SAAU,uCAAcH,KAAKgC,iEACPhC,KAAKD,iBAAkBI"}